# Majeure SD 2020-2021
# S?ries Temporelles - TP mini-challenge

library(fUnitRoots)

data <- read.table('Data_app.txt',header=T)
test <- read.table('Data_test.txt',header = T)

data.ts <- ts(data,frequency = 12,start=c(1980,1))
test.ts <- ts(test,frequency = 12,start=c(1994,1))

# S?rie de consommation d'?lectricit? 
kwh <- data.ts[,"kwh"] 
plot(kwh,type='l',main="Consommation ?lectricit?",cex.main=0.8)
grid()

# S?ries htdd (heating degree day / chauffage) et cldd (cooling degree day / climatisation)
htdd <- data.ts[,"htdd"]
plot(htdd,type='l',main="S?rie HTDD",cex.main=0.8)
grid()
cldd <- data.ts[,"cldd"]
plot(cldd,type='l',main="S?rie CLDD",cex.main=0.8)
grid()


# Visualisation conjointe des 3 s?ries

plot(kwh,type='l',main="",xlab="")
grid()
title("Donn?es d'apprentissage")
plot(htdd,type='l',xlab="")
grid()
plot(cldd,type='l',xlab="")
grid()


kwh.diff1 <- diff(data$kwh,differences = 1)
kwh.diff2 <- diff(data$kwh,differences = 2)
logkwh.diff1 <-diff(log(data$kwh),differences = 1)
acf(kwh.diff1,ylim = c(-1,1))
pacf(kwh.diff1,ylim = c(-1,1))

acf(kwh.diff2,ylim = c(-1,1))
pacf(kwh.diff2,ylim = c(-1,1))

acf(logkwh.diff1,ylim = c(-1,1),lag.max = 100)
pacf(logkwh.diff1,ylim = c(-1,1))

plot(kwh.diff2)
# s=12


unitrootTest(kwh.diff2)#???p???????????????0.05,????????????????????????
Box.test(kwh.diff2,type = "Ljung-Box") #???????????????
# ???????????????,?????????????????????????????????
# ?????????????????????,???????????????????????????????????????,????????????????????????,??????????????????

#???????????????
model <- arima(log(kwh),order=c(2,2,11), xreg = cbind(htdd,cldd),
               seasonal = list(order=c(1,1,0),period=12))

model
residus <- model$residuals
Box.test(residus,type = "Ljung-Box")
qqnorm(residus, main = "Normal Q-Q Plot", xlab = "Theoretical Quantiles", ylab = "Sample Quantiles",
       plot.it = TRUE)
qqline(residus,col="red")
prevision <- predict(model,newxreg = cbind(test$htdd,test$cldd), n.ahead=12, prediction.interval=T)
plot(kwh)
par(new = TRUE)
plot(prevision$pred)
pred <- exp(prevision$pred)
print(pred)
comb <- c(kwh,pred)
plot(comb,type='l')



